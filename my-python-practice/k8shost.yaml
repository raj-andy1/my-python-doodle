AWSTemplateFormatVersion: "2010-09-09"
Description: "template to provision ec2 instances to install K8s"
Resources:
  DummyServer:
    Type: "AWS::EC2::Instance"
    Properties:
      ImageId:  "ami-0dd273d94ed0540c0"
      BlockDeviceMappings:
        - DeviceName: "/dev/sdb"
          Ebs:
            VolumeType: "gp2"
            DeleteOnTermination: "false"
            VolumeSize: "20"
      InstanceType: "t3.medium"
      IamInstanceProfile: "FieldOperationsGovernance"
      SecurityGroupIds: ["sg-040889562f1659c13"]
      Tags:
        -
          Key: "resource_owner"
          Value: "arajagopalan"
        -
          Key: "service_name"
          Value: "self-learning"
        -
          Key: "business_unit"
          Value: "FieldOperations"
        -
          Key: "Name"
          Value: !Ref AWS::StackName

      UserData: "#!/bin/sh

sudo apt-get update
sudo apt-get install -y apt-transport-https ca-certificates curl gnupg lsb-release

#download docker public key
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
echo 'deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable' | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

#install docker
sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io

#Configure the Docker daemon, in particular to use systemd for the management of the container���s cgroups
cat <<EOF | sudo tee /etc/docker/daemon.json
{
  'exec-opts': ['native.cgroupdriver=systemd'],
  'log-driver': 'json-file',
  'log-opts': {
    'max-size': '100m'
  },
  'storage-driver': 'overlay2'
}
EOF

#Restart Docker and enable on boot:

sudo /bin/systemctl enable docker
sudo /bin/systemctl daemon-reload
sudo /bin/systemctl restart docker


#Download the Google Cloud public signing key:
sudo curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg

#Add the Kubernetes apt repository
echo 'deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main' | sudo tee /etc/apt/sources.list.d/kubernetes.list

#Update apt package index, install kubelet, kubeadm and kubectl, and pin their version
sudo apt-get update
sudo apt-get install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl"

